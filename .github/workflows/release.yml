name: ğŸš€ Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ğŸ” Create Release Draft
  create-release:
    name: ğŸ“¦ Create Release
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.result }}
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Get Version
        id: get-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ Create Release Draft
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: '${{ steps.get-version.outputs.version }}',
              name: 'ğŸ¬ Thai Video Downloader ${{ steps.get-version.outputs.version }}',
              body: `## ğŸ†• What's New

            ### âœ¨ New Features
            - ğŸ“‹ Clipboard auto-paste - à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸š URL à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
            - âŒ¨ï¸ Keyboard shortcuts - Enter, Escape, Ctrl+O
            - ğŸ”” Desktop notifications - à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¹€à¸¡à¸·à¹ˆà¸­à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¹€à¸ªà¸£à¹‡à¸ˆ
            - âš¡ Speed & ETA display - à¹à¸ªà¸”à¸‡à¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§à¹à¸¥à¸°à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­

            ### ğŸ› Bug Fixes
            - Fixed various UI issues
            - Improved error handling

            ### ğŸ“¥ Downloads

            | Platform | File |
            |----------|------|
            | ğŸªŸ Windows | \`ThaiVideoDownloader_${{ steps.get-version.outputs.version }}_x64-setup.exe\` |
            | ğŸ macOS (Intel) | \`ThaiVideoDownloader_${{ steps.get-version.outputs.version }}_x64.dmg\` |
            | ğŸ macOS (Apple Silicon) | \`ThaiVideoDownloader_${{ steps.get-version.outputs.version }}_aarch64.dmg\` |
            | ğŸ§ Linux (deb) | \`ThaiVideoDownloader_${{ steps.get-version.outputs.version }}_amd64.deb\` |
            | ğŸ§ Linux (AppImage) | \`ThaiVideoDownloader_${{ steps.get-version.outputs.version }}_amd64.AppImage\` |

            ---
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/...v${{ steps.get-version.outputs.version }}
            `,
              draft: true,
              prerelease: false
            })
            return data.id

  # ğŸªŸ Build Windows
  build-windows:
    name: ğŸªŸ Build Windows
    needs: create-release
    runs-on: windows-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: gui/src-tauri

      - name: ğŸ“— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: gui/package-lock.json

      - name: ğŸ“¦ Install Dependencies
        working-directory: gui
        run: npm ci

      - name: ğŸ”¨ Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: gui
          releaseId: ${{ needs.create-release.outputs.release_id }}

  # ğŸ Build macOS (Intel)
  build-macos-intel:
    name: ğŸ Build macOS (Intel)
    needs: create-release
    runs-on: macos-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: gui/src-tauri

      - name: ğŸ“— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: gui/package-lock.json

      - name: ğŸ“¦ Install Dependencies
        working-directory: gui
        run: npm ci

      - name: ğŸ”¨ Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: gui
          releaseId: ${{ needs.create-release.outputs.release_id }}

  # ğŸ Build macOS (Apple Silicon)
  build-macos-arm:
    name: ğŸ Build macOS (Apple Silicon)
    needs: create-release
    runs-on: macos-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: ğŸ“¦ Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: gui/src-tauri

      - name: ğŸ“— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: gui/package-lock.json

      - name: ğŸ“¦ Install Dependencies
        working-directory: gui
        run: npm ci

      - name: ğŸ”¨ Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: gui
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: --target aarch64-apple-darwin

  # ğŸ§ Build Linux
  build-linux:
    name: ğŸ§ Build Linux
    needs: create-release
    runs-on: ubuntu-22.04
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§ Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: gui/src-tauri

      - name: ğŸ“— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: gui/package-lock.json

      - name: ğŸ“¦ Install Dependencies
        working-directory: gui
        run: npm ci

      - name: ğŸ”¨ Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: gui
          releaseId: ${{ needs.create-release.outputs.release_id }}

  # âœ… Publish Release
  publish-release:
    name: âœ… Publish Release
    needs: [create-release, build-windows, build-macos-intel, build-macos-arm, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ‰ Publish Release
        uses: actions/github-script@v7
        env:
          release_id: ${{ needs.create-release.outputs.release_id }}
        with:
          script: |
            github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: process.env.release_id,
              draft: false
            })
